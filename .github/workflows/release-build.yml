name: Build Windows EXE (PyInstaller)

on:
  release:
    types: [published, prereleased]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to upload to (e.g. 2.3.3 or v2.3.3). Leave empty for build-only."
        required: false
        default: ""
      upload_to_release:
        description: "Upload the .exe to the release matching the tag (supports drafts)."
        required: false
        default: "false"
        type: choice
        options: ["false", "true"]

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: (Manual) Checkout requested tag (sanitized)
        if: github.event_name == 'workflow_dispatch' && inputs.tag != ''
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $tag = "${{ inputs.tag }}".Trim()
          if ([string]::IsNullOrWhiteSpace($tag)) {
            throw "Input 'tag' is empty/whitespace after trimming."
          }

          git fetch --tags --force
          git checkout "$tag"

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install runtime dependencies + build tool
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          if (!(Test-Path "requirements.txt")) {
            throw "requirements.txt not found in repository root."
          }

          python -m pip install --upgrade pip
          pip install -r requirements.txt

          # Build tool (kept out of requirements.txt on purpose)
          pip install pyinstaller

      - name: Build (PyInstaller)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          if (!(Test-Path ".\assets\app.ico")) {
            throw "Missing icon: assets\app.ico"
          }
          if (!(Test-Path ".\ARK-Ascended-Server-Manager.py")) {
            throw "Missing entry script: ARK-Ascended-Server-Manager.py"
          }

          pyinstaller --noconfirm --clean --onefile --windowed `
            --name "ARK-ASA-Manager" `
            --icon ".\assets\app.ico" `
            --add-data ".\assets;assets" `
            --collect-all rcon `
            ".\ARK-Ascended-Server-Manager.py"

          if (!(Test-Path "dist\ARK-ASA-Manager.exe")) {
            throw "Build failed: dist\ARK-ASA-Manager.exe not found."
          }

      - name: Create checksum (sha256)
        id: meta
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # Use Windows paths for filesystem ops...
          $exe_fs = "dist\ARK-ASA-Manager.exe"
          $sha_fs = "dist\ARK-ASA-Manager.exe.sha256"

          $hash = (Get-FileHash -Path $exe_fs -Algorithm SHA256).Hash.ToLower()
          "$hash  ARK-ASA-Manager.exe" | Out-File -FilePath $sha_fs -Encoding ascii -Force

          # ...but output POSIX paths for action-gh-release glob matching.
          "exe_path=dist/ARK-ASA-Manager.exe" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "sha_path=dist/ARK-ASA-Manager.exe.sha256" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Upload artifact (workflow)
        uses: actions/upload-artifact@v6
        with:
          name: ARK-ASA-Manager-windows
          path: |
            ${{ steps.meta.outputs.exe_path }}
            ${{ steps.meta.outputs.sha_path }}
          if-no-files-found: error

      - name: Debug dist output
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          Get-ChildItem -Force -Recurse dist | Format-Table FullName, Length

      - name: Upload to GitHub Release (on publish/prerelease)
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: |
            ${{ steps.meta.outputs.exe_path }}
            ${{ steps.meta.outputs.sha_path }}
          fail_on_unmatched_files: true

      - name: Upload to existing Release (manual, supports drafts, auto-create)
        if: github.event_name == 'workflow_dispatch' && inputs.upload_to_release == 'true' && inputs.tag != ''
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $ErrorActionPreference = "Stop"

          $tag = "${{ inputs.tag }}".Trim()
          if ([string]::IsNullOrWhiteSpace($tag)) {
            throw "Input 'tag' is empty/whitespace after trimming."
          }

          $exe = "${{ steps.meta.outputs.exe_path }}"
          $sha = "${{ steps.meta.outputs.sha_path }}"

          # Ensure release exists (create draft if missing)
          $exists = $true
          try {
            gh release view "$tag" | Out-Null
          } catch {
            $exists = $false
          }

          if (-not $exists) {
            Write-Host "Release for tag '$tag' not found. Creating a draft release..."
            gh release create "$tag" --draft --title "$tag" --notes "Automated build upload."
          } else {
            Write-Host "Release for tag '$tag' found."
          }

          gh release upload "$tag" "$exe" --clobber
          gh release upload "$tag" "$sha" --clobber
